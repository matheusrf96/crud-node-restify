<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Crud NodeJS - Restify</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        #texto {
            display: inline;
            vertical-align: middle;
            width: auto;
        }  
        .update{
            margin-left: -10px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cadastro</h1>
        <div class="row">
            <div class="col-6">
                <input type="text" id="texto" class="form-control"/>
                <button id="botao" class="btn btn-success">
                    Enviar
                    <i class="fa fa-check" aria-hidden="true"></i>
                </button>
            </div>
        </div>

        <hr />
        <h2>Lista de Nomes</h2>
        <div class="row">
            <div class="col-6">
                <ul class="list-group" id="lista"></ul>
            </div>
        </div>
    </div>

<script>

    window.onload = () =>{
        const lista = document.querySelector('#lista');
        const botao = document.querySelector('#botao');
        const texto = document.querySelector('#texto');

        botao.addEventListener('click', create);
        lista.addEventListener('click', del);
        lista.addEventListener('click', edit);

        read();
    }

    function templateLi(id, nome, element = true){
        return `
            ${element ? `<li class="list-group-item row">` : ''}
                <div class="col-10">${nome}</div>
                <i class="btn btn-primary col-1 text-right update fa fa-wrench"
                    data-id="${id}";
                ></i>
                <i class="btn btn-danger col-1 text-right delete fa fa-trash"
                    data-id="${id}";
                ></i>
            ${element ? `</li>` : ''}
        `;
    }

    function read(){
        lista.innerHTML = "";

        //chamada ajax
        axios.get('/read/')
            .then((response) => {
                console.log(response.data);

                response.data.forEach(element => {
                    lista.innerHTML += templateLi(element.id, element.name);
                });
            })
            .catch((error) => {
                console.log(error);
            });
    }

    function create(){
        const name = texto.value;

        axios.post('/create/', {name: name})
            .then((response) => {
                console.log(response.data);
                lista.innerHTML += templateLi(response.data[0], name);
            })
            .catch((error) => {
                console.log(error);
            });
    }

    function edit(element){
        if(element.target.classList.contains('update')){
            const id = element.target.dataset.id;

            const input = document.createElement('input');
            input.type = 'text';
            input.setAttribute('value', '');

            const pai = element.target.parentElement;
            pai.innerHTML = '';
            pai.appendChild(input);

            input.addEventListener('keydown', update.bind(pai, id, input));
            input.focus();
        }
    }

    function update(id, input){
        const key = event.key;
        if(key == null || key != 'Enter') return;

        axios.put(`/update/${id}`, {name: input.value})
            .then((response) => {
                console.log(response.data);

                if(response.status == 200){
                    this.innerHTML = templateLi(id, input.value, false);
                }
            })
            .catch((error) => {
                console.log(error);
            });
    }

    function del(element){
        console.log(element);

        if(element.target.classList.contains('delete')){
            //Pega o id do elemento
            const id = element.target.dataset.id;

            axios.delete(`/delete/${id}`)
                .then((response) => {
                    console.log(response.data);

                    if(response.status == 200){
                        //Se a exclusÃ£o for bem-sucedida, exclui o elemento pai
                        lista.removeChild(element.target.parentElement);
                    }
                })
                .catch((error) => {
                    console.log(error);
                });
        }
    }
</script>
</body>
</html>